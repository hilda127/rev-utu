{"version":3,"file":"component---src-templates-book-template-js-35c12e5d7447688781c2.js","mappings":"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","sources":["webpack://create-react-app/./src/components/IconSettings.js","webpack://create-react-app/./src/templates/BookTemplate.module.css","webpack://create-react-app/./src/templates/BookTemplate.js"],"sourcesContent":["import React from \"react\";\n\nexport default function IconSettings(props) {\n  const { className } = props;\n\n  return (\n    <svg\n      xmlns=\"http://www.w3.org/2000/svg\"\n      viewBox=\"0 0 512 512\"\n      className={className}\n    >\n      <path d=\"M272.07 512h-32.14a47.19 47.19 0 01-47.13-47.13V454a206.7 206.7 0 01-32.1-13.33l-7.7 7.7c-18.66 18.69-48.55 18.14-66.67 0l-22.7-22.71c-18.16-18.13-18.68-48 0-66.66l7.7-7.7A206.71 206.71 0 0158 319.2H47.13A47.19 47.19 0 010 272.07v-32.14a47.19 47.19 0 0147.13-47.13H58a206.75 206.75 0 0113.33-32.1l-7.7-7.7c-18.67-18.65-18.16-48.53 0-66.66l22.71-22.72a47.13 47.13 0 0166.67 0l7.7 7.7A206.9 206.9 0 01192.8 58V47.13A47.19 47.19 0 01239.93 0h32.14a47.19 47.19 0 0147.13 47.13V58a206.7 206.7 0 0132.1 13.33l7.7-7.7c18.66-18.69 48.55-18.14 66.67 0l22.7 22.71c18.16 18.13 18.68 48 0 66.67l-7.7 7.7A206.71 206.71 0 01454 192.8h10.87A47.19 47.19 0 01512 239.93v32.14a47.19 47.19 0 01-47.13 47.13H454a206.75 206.75 0 01-13.33 32.1l7.7 7.7c18.67 18.65 18.16 48.53 0 66.67l-22.71 22.7a47.13 47.13 0 01-66.67 0l-7.7-7.7A206.9 206.9 0 01319.2 454v10.87A47.19 47.19 0 01272.07 512zM165.72 409.17a176.81 176.81 0 0045.83 19.02 15 15 0 0111.25 14.53v22.15c0 9.44 7.69 17.13 17.13 17.13h32.14c9.44 0 17.13-7.69 17.13-17.13v-22.15a15 15 0 0111.25-14.53 176.81 176.81 0 0045.83-19.02 15 15 0 0118.25 2.3l15.69 15.7a17.13 17.13 0 0024.22 0l22.73-22.72a17.13 17.13 0 000-24.23l-15.7-15.7a15 15 0 01-2.3-18.24 176.78 176.78 0 0019.03-45.83 15 15 0 0114.52-11.25h22.15c9.44 0 17.13-7.68 17.13-17.13v-32.14c0-9.44-7.69-17.13-17.13-17.13h-22.15a15 15 0 01-14.52-11.25 176.82 176.82 0 00-19.03-45.83 15 15 0 012.3-18.24l15.7-15.7a17.13 17.13 0 000-24.22l-22.72-22.72a17.13 17.13 0 00-24.23 0l-15.7 15.69a15 15 0 01-18.24 2.3 176.81 176.81 0 00-45.83-19.02 15 15 0 01-11.25-14.53V47.13c0-9.44-7.69-17.13-17.13-17.13h-32.14a17.15 17.15 0 00-17.13 17.13v22.15a15 15 0 01-11.25 14.53 176.81 176.81 0 00-45.83 19.02 15 15 0 01-18.25-2.3l-15.68-15.7a17.13 17.13 0 00-24.23 0l-22.72 22.73a17.13 17.13 0 00-.01 24.22l15.7 15.7a15 15 0 012.3 18.24 176.78 176.78 0 00-19.02 45.83 15 15 0 01-14.53 11.25H47.13A17.15 17.15 0 0030 239.93v32.14c0 9.44 7.69 17.13 17.13 17.13h22.15a15 15 0 0114.52 11.25 176.82 176.82 0 0019.03 45.83 15 15 0 01-2.3 18.24l-15.7 15.7a17.13 17.13 0 000 24.22l22.72 22.72a17.13 17.13 0 0024.23 0l15.7-15.69c3.56-3.56 10.98-6.59 18.24-2.3z\" />\n      <path d=\"M256 367.4c-61.43 0-111.4-49.97-111.4-111.4S194.57 144.6 256 144.6 367.4 194.57 367.4 256 317.43 367.4 256 367.4zm0-192.8c-44.88 0-81.4 36.52-81.4 81.4s36.52 81.4 81.4 81.4 81.4-36.52 81.4-81.4-36.52-81.4-81.4-81.4z\" />\n    </svg>\n  );\n}\n","// extracted by mini-css-extract-plugin\nexport var footer = \"BookTemplate-module--footer--mRAeM\";\nexport var footerNavButton = \"BookTemplate-module--footerNavButton--o+QWW\";\nexport var header = \"BookTemplate-module--header--4udBQ\";\nexport var headerBackIcon = \"BookTemplate-module--headerBackIcon--0k6rd\";\nexport var headerBackLink = \"BookTemplate-module--headerBackLink--pFjGl\";\nexport var headerButton = \"BookTemplate-module--headerButton--AOZcV\";\nexport var headerHidden = \"BookTemplate-module--headerHidden--HHAj3\";\nexport var headerIcon = \"BookTemplate-module--headerIcon--0XrgX\";\nexport var headerLeftSection = \"BookTemplate-module--headerLeftSection--fHNou\";\nexport var headerNavButton = \"BookTemplate-module--headerNavButton--fAKBJ\";\nexport var headerRightSection = \"BookTemplate-module--headerRightSection--hPdRu\";\nexport var headerTitle = \"BookTemplate-module--headerTitle--Ba0Qi\";\nexport var page = \"BookTemplate-module--page--767ks\";\nexport var pageImage = \"BookTemplate-module--pageImage--jAHaD\";\nexport var pagePadding = \"BookTemplate-module--pagePadding--vQxtc\";\nexport var pageSpanHeight = \"BookTemplate-module--pageSpanHeight--+tUNP\";\nexport var pageSpanWidth = \"BookTemplate-module--pageSpanWidth--NH2X7\";\nexport var pageWebtoon = \"BookTemplate-module--pageWebtoon--6scOl\";\nexport var pageWrapper = \"BookTemplate-module--pageWrapper--oPmzd\";","import React, {\n  useMemo,\n  useEffect,\n  useState,\n  useRef,\n  useCallback,\n} from \"react\";\nimport { graphql, Link } from \"gatsby\";\nimport { useInView } from \"react-intersection-observer\";\nimport classnames from \"classnames\";\n\nimport { decryptBuffer, createBlobUrl } from \"../utils/crypto\";\nimport { fetchWithRetries } from \"../utils/fetch\";\nimport { decrypt } from \"../utils/string\";\nimport Layout from \"../components/Layout\";\nimport Logo from \"../components/Logo\";\nimport IconSettings from \"../components/IconSettings\";\nimport Image from \"../components/Image\";\nimport useLocalStorage from \"../hooks/useLocalStorage\";\nimport useWindowSize from \"../hooks/useWindowSize\";\n\nimport * as styles from \"./BookTemplate.module.css\";\n\nconst READING_MODE_KEY = \"reading_mode\";\nconst READING_MODE_WIDTH = \"0\";\nconst READING_MODE_HEIGHT = \"1\";\nconst READING_MODE_WEBTOON = \"2\";\nconst READING_MODE_COUNT = 3;\n\nexport default function BookTemplate(props) {\n  const {\n    data: {\n      bookMeta: { dimensions, name },\n      bookPages,\n    },\n    pageContext: { prevPath, nextPath },\n  } = props;\n  const decryptedName = useMemo(() => decrypt(name), [name]);\n  const [readingMode, setReadingMode] = useLocalStorage(\n    READING_MODE_KEY,\n    READING_MODE_WIDTH\n  );\n  const { width: windowWidth, height: windowHeight } = useWindowSize();\n  const [navHidden, setNavHidden] = useState(true);\n\n  const goBack = useCallback((pageIndex) => {\n    const currentPageEl = document.getElementById(`page-${pageIndex}`);\n    const currentPageTop = currentPageEl.getBoundingClientRect().top;\n    if (currentPageTop < -5) {\n      currentPageEl.scrollIntoView();\n    } else if (pageIndex > 0) {\n      const prevPageEl = document.getElementById(`page-${pageIndex - 1}`);\n      prevPageEl.scrollIntoView();\n    }\n  }, []);\n\n  const goForward = useCallback((pageIndex) => {\n    const currentPageEl = document.getElementById(`page-${pageIndex}`);\n    const currentPageTop = currentPageEl.getBoundingClientRect().top;\n    if (currentPageTop > 5) {\n      currentPageEl.scrollIntoView();\n    } else if (pageIndex < bookPages.edges.length - 1) {\n      const nextPageEl = document.getElementById(`page-${pageIndex + 1}`);\n      nextPageEl.scrollIntoView();\n    }\n  }, []);\n\n  useEffect(() => {}, [goBack, goForward]);\n\n  function onPageClick(e, pageIndex) {\n    const windowWidth = window.innerWidth;\n    const clickX = e.clientX;\n    if (clickX < windowWidth / 10) {\n      goBack(pageIndex);\n    } else if (clickX < (9 * windowWidth) / 10) {\n      setNavHidden((flag) => !flag);\n    } else {\n      goForward(pageIndex);\n    }\n  }\n\n  function onSettingsButtonClick() {\n    setReadingMode(String((parseInt(readingMode) + 1) % READING_MODE_COUNT));\n  }\n\n  return (\n    <Layout>\n      <Header\n        title={decryptedName}\n        hidden={navHidden}\n        onSettingsButtonClick={onSettingsButtonClick}\n        {...{ prevPath, nextPath }}\n      />\n      {bookPages.edges.map(({ node: { publicURL } }, index) => {\n        const [pageWidth, pageHeight] = dimensions[index];\n        return (\n          <Page\n            {...{\n              index,\n              pageHeight,\n              pageWidth,\n              publicURL,\n              readingMode,\n              windowHeight,\n              windowWidth,\n              onPageClick,\n            }}\n            key={publicURL}\n          />\n        );\n      })}\n      <div className={styles.footer}>\n        {prevPath != null ? (\n          <Link to={prevPath} className={styles.footerNavButton}>\n            PREV\n          </Link>\n        ) : null}\n        {nextPath != null ? (\n          <Link to={nextPath} className={styles.footerNavButton}>\n            NEXT\n          </Link>\n        ) : null}\n      </div>\n    </Layout>\n  );\n}\n\nfunction Header(props) {\n  const { title, hidden, onSettingsButtonClick, prevPath, nextPath } = props;\n  const headerClassName = classnames(styles.header, {\n    [styles.headerHidden]: hidden,\n  });\n\n  return (\n    <div className={headerClassName}>\n      <div className={styles.headerLeftSection}>\n        <Link to=\"/\" className={styles.headerBackLink}>\n          <Logo className={styles.headerBackIcon} />\n        </Link>\n        <div>\n          <p className={styles.headerTitle}>{title}</p>\n        </div>\n        {prevPath != null ? (\n          <Link to={prevPath} className={styles.headerNavButton}>\n            PREV\n          </Link>\n        ) : null}\n        {nextPath != null ? (\n          <Link to={nextPath} className={styles.headerNavButton}>\n            NEXT\n          </Link>\n        ) : null}\n      </div>\n      <div className={styles.headerRightSection}>\n        <button className={styles.headerButton} onClick={onSettingsButtonClick}>\n          <IconSettings className={styles.headerIcon} />\n        </button>\n      </div>\n    </div>\n  );\n}\n\nfunction Page(props) {\n  const {\n    index,\n    pageHeight,\n    pageWidth,\n    publicURL,\n    readingMode,\n    windowHeight,\n    windowWidth,\n    onPageClick,\n  } = props;\n  const [imageBuffer, setImageBuffer] = useState(null);\n  const [blobUrl, setBlobUrl] = useState(null);\n  const onceRef = useRef(false);\n  const { ref, inView } = useInView({\n    rootMargin: `${windowHeight * 2.5}px 0px ${windowHeight * 3.5}px`,\n  });\n\n  useEffect(() => {\n    async function fetchImage() {\n      const res = await fetchWithRetries(publicURL, 1000, 5);\n      const buffer = await res.arrayBuffer();\n      setImageBuffer(decryptBuffer(buffer));\n    }\n    if (inView && !onceRef.current) {\n      fetchImage();\n      onceRef.current = true;\n    }\n  }, [inView, publicURL]);\n\n  useEffect(() => {\n    if (inView) {\n      setBlobUrl(createBlobUrl(imageBuffer));\n    }\n\n    return () => {\n      if (blobUrl != null) {\n        URL.revokeObjectURL(blobUrl);\n      }\n    };\n  }, [imageBuffer, inView]);\n\n  const windowRatio = windowHeight / windowWidth;\n  const pageRatio = pageHeight / pageWidth;\n\n  const shouldSpanWidth = readingMode !== READING_MODE_HEIGHT;\n\n  const pageClassName = classnames(styles.page, {\n    [styles.pageSpanWidth]: shouldSpanWidth,\n    [styles.pageSpanHeight]: !shouldSpanWidth,\n    [styles.pageWebtoon]: readingMode === READING_MODE_WEBTOON,\n  });\n\n  return (\n    <div\n      className={pageClassName}\n      id={`page-${index}`}\n      ref={ref}\n      onClick={(e) => onPageClick(e, index)}\n    >\n      <div\n        className={styles.pageWrapper}\n        style={\n          !shouldSpanWidth\n            ? {\n                width:\n                  pageRatio < windowRatio ? \"100%\" : `${100 / pageRatio}vh`,\n              }\n            : undefined\n        }\n      >\n        {shouldSpanWidth ? (\n          <div\n            className={styles.pagePadding}\n            style={{\n              paddingTop: `${pageRatio * 100}%`,\n            }}\n          />\n        ) : null}\n        {inView && blobUrl != null ? (\n          <Image className={styles.pageImage} src={blobUrl} />\n        ) : null}\n      </div>\n    </div>\n  );\n}\n\nexport const pageQuery = graphql`\n  query BookByName($name: String!) {\n    bookMeta: json(name: { eq: $name }) {\n      dimensions\n      name\n    }\n    bookPages: allFile(\n      sort: { fields: relativePath }\n      filter: {\n        relativeDirectory: { eq: $name }\n        extension: { nin: [\"json\"] }\n        name: { regex: \"/^(?!thumbnail).*/\" }\n      }\n    ) {\n      edges {\n        node {\n          relativePath\n          publicURL\n          name\n        }\n      }\n    }\n  }\n`;\n"],"names":["IconSettings","props","className","xmlns","viewBox","d","footerNavButton","headerNavButton","BookTemplate","data","bookMeta","dimensions","name","bookPages","pageContext","prevPath","nextPath","decryptedName","useMemo","decrypt","useLocalStorage","readingMode","setReadingMode","useWindowSize","windowWidth","width","windowHeight","height","useState","navHidden","setNavHidden","goBack","useCallback","pageIndex","currentPageEl","document","getElementById","getBoundingClientRect","top","scrollIntoView","goForward","edges","length","onPageClick","e","window","innerWidth","clickX","clientX","flag","useEffect","Layout","Header","title","hidden","onSettingsButtonClick","String","parseInt","map","index","publicURL","node","pageWidth","pageHeight","Page","key","Link","to","styles","headerClassName","classnames","Logo","onClick","imageBuffer","setImageBuffer","blobUrl","setBlobUrl","onceRef","useRef","useInView","rootMargin","ref","inView","fetchWithRetries","res","arrayBuffer","buffer","decryptBuffer","current","fetchImage","createBlobUrl","URL","revokeObjectURL","windowRatio","pageRatio","shouldSpanWidth","pageClassName","id","style","undefined","paddingTop","Image","src"],"sourceRoot":""}